---
title: "Random Forest Model Results"
---

```{r}
#| label: setup
#| include: false

knitr::opts_chunk$set(echo = T)
options(tidyverse.quiet = T)

library(targets)
tar_source('R')

tar_load(final_models)
tar_load(dataset_split)
```

# Interpretation

This document begins with summary tables, which include the results for all models. The first table summarizes the results for temperature models, the second for air pollution. Each row in the tables represents a different model, with columns representing the most important predictor variables for that model. The relationships between the predictor and response are in brackets, inc = positive relationship, dec = negative relationship, mixed means that there are both positive and negative relationships depending on the city. The air pollution table shows models for 5 different pollutants, at two different scales.

The figures are then presented for each model. The first figure, a 2 panel scatterplot shows the fit of the model based on the training and testing datasets. The second figure is a variance importance plot, which depicts the most important predictors for each model. This value is derived from taking the average model improvement score when that specific predictor is added across many model iterations. Finally, there are the partial dependency plots which depict the relationship between the top 10 predictor variables and the response variable, across all cities. It is important to note however, that not all 10 variables are always important predictors (you can check which ones are from the vip plots or summary tables). Also, the partial dependency plots are sorted alphabetically, not in order of variable importance.

# Summary Tables

## Temperature

| Scale | Predictor 1 | Predictor 2 | Predictor 3 | Predictor 4 | Predictor 5 | Predictor 6 | Predictor 7 | Predictor 8 |
|--------|--------|--------|--------|--------|--------|--------|--------|--------|
| City | day of year | NDVI (dec) | NDBI (inc) | \% immigrants (inc) | \% vis minorities (inc) |  |  |  |
| Neighbourhood | area (dec) | mean DBH (mixed) | basal area (mixed) | stem density (mixed) | std dev DBH (mixed) | functional group Shannon (inc) | species richness (dec) | Shannon (mixed) |
| Street | street direction |  |  |  |  |  |  |  |

## Air Pollution

| Pollutant-Scale | Predictor 1 | Predictor 2 | Predictor 3 | Predictor 4 | Predictor 5 | Predictor 6 | Predictor 7 | Predictor 8 |
|--------|--------|--------|--------|--------|--------|--------|--------|--------|
| UV - city | day of year | NDVI (dec) | NDBI (inc) |  |  |  |  |  |
| CO - city | day of year |  |  |  |  |  |  |  |
| SO2 - city | day of year | NDBI (inc) | NDVI (dec) | road density (inc) |  |  |  |  |
| NO2 - city | day of year | \% trailers (dec) | \% Indigenous (dec) | \% single detached homes (dec) |  |  |  |  |
| O3 - city | day of year | NDBI (inc) |  |  |  |  |  |  |
| UV - neighbourhood | area | basal area | stem density | species richness | functional group Shannon |  |  |  |
| CO - neighbourhood | area (mixed) | basal area (dec) | DBH (inc) | Shannon (mixed) | stem density (dec) | std dev DBH (dec) | species richness (mixed) | functional group Shannon (dec) |
| SO2 - neighbourhood | basal area (inc) | area (inc) | stem dens (inc) | mean DBH (dec) | std dev DBH (mixed) | functional group Shannon (inc) | Shannon (inc) | species richness (inc) |
| NO2 - neighbourhood | area (inc) | basal area (mixed) | mean DBH (dec) | Shannon (inc) | stem density (mixed) | std dev DBH (mixed) | species richness (inc) | functional group Shannon (mixed) |
| O3 - neighbourhood | area (inc) | mean DBH (mixed) | basal area (dec) | stem dens (dec) | Shannon (mixed) | std dev DBH (dec) | functional group Shannon (mixed) | species richness (mixed) |

# Land Surface Temperature

## City Scale

Model fit:

![](../graphics/cities_temp_model-fit.png)

Most important variables:

```{r}
#| echo: false
#| eval: true
#| label: city-temp-metrics

last_rf_model <- final_models$cities_temp
df_train <- dataset_split[[1]]$train
df_test <- dataset_split[[1]]$test

bind_rows(
  augment(last_rf_model, new_data = df_train) %>% 
    mutate(type = "train"),
  augment(last_rf_model, new_data = df_test) %>% 
    mutate(type = "test")) %>% 
  group_by(type) %>% 
  metrics(value, .pred)
```

![](../graphics/cities_temp_vip.png)

Relationships with most important variables:

![](../graphics/cities_temp_pdp.png)

## Neighbourhood Scale

Model fit:

![](../graphics/neighbourhoods_temp_model-fit.png)

Most important variables:

```{r}
#| echo: false
#| eval: true
#| label: nhood-temp-metrics

last_rf_model <- final_models$neighbourhoods_temp
df_train <- dataset_split[[7]]$train
df_test <- dataset_split[[7]]$test

bind_rows(
  augment(last_rf_model, new_data = df_train) %>% 
    mutate(type = "train"),
  augment(last_rf_model, new_data = df_test) %>% 
    mutate(type = "test")) %>% 
  group_by(type) %>% 
  metrics(value, .pred)
```

![](../graphics/neighbourhoods_temp_vip.png)

Relationships with most important variables:

![](../graphics/neighbourhoods_temp_pdp.png)

## Street Scale

Model fit:

![](../graphics/streets_temp_model-fit.png)

Most important variables:

```{r}
#| echo: false
#| eval: true
#| label: street-temp-metrics

last_rf_model <- final_models$streets_temp
df_train <- dataset_split[[13]]$train
df_test <- dataset_split[[13]]$test

bind_rows(
  augment(last_rf_model, new_data = df_train) %>% 
    mutate(type = "train"),
  augment(last_rf_model, new_data = df_test) %>% 
    mutate(type = "test")) %>% 
  group_by(type) %>% 
  metrics(value, .pred)
```

![](../graphics/streets_temp_vip.png)

Relationships with most important variables:

![](../graphics/streets_temp_pdp.png)

# UV

## City Scale

![](../graphics/cities_UV_model-fit.png)

Most important variables:

```{r}
#| echo: false
#| eval: true
#| label: city-uv-metrics

last_rf_model <- final_models$cities_UV
df_train <- dataset_split[[2]]$train
df_test <- dataset_split[[2]]$test

bind_rows(
  augment(last_rf_model, new_data = df_train) %>% 
    mutate(type = "train"),
  augment(last_rf_model, new_data = df_test) %>% 
    mutate(type = "test")) %>% 
  group_by(type) %>% 
  metrics(value, .pred)
```

![](../graphics/cities_UV_vip.png)

Relationships with most important variables:

![](../graphics/cities_UV_pdp.png)

## Neighbourhood Scale

Model fit:

![](../graphics/neighbourhoods_UV_model-fit.png)

Most important variables:

```{r}
#| echo: false
#| eval: true
#| label: nhood-uv-metrics

last_rf_model <- final_models$neighbourhoods_UV
df_train <- dataset_split[[8]]$train
df_test <- dataset_split[[8]]$test

bind_rows(
  augment(last_rf_model, new_data = df_train) %>% 
    mutate(type = "train"),
  augment(last_rf_model, new_data = df_test) %>% 
    mutate(type = "test")) %>% 
  group_by(type) %>% 
  metrics(value, .pred)
```

![](../graphics/neighbourhoods_UV_vip.png)

Relationships with most important variables:

![](../graphics/neighbourhoods_UV_pdp.png)

# CO

## City Scale

![](../graphics/cities_CO_model-fit.png)

Most important variables:

```{r}
#| echo: false
#| eval: true
#| label: city-co-metrics

last_rf_model <- final_models$cities_CO
df_train <- dataset_split[[3]]$train
df_test <- dataset_split[[3]]$test

bind_rows(
  augment(last_rf_model, new_data = df_train) %>% 
    mutate(type = "train"),
  augment(last_rf_model, new_data = df_test) %>% 
    mutate(type = "test")) %>% 
  group_by(type) %>% 
  metrics(value, .pred)
```

![](../graphics/cities_CO_vip.png)

Relationships with most important variables:

![](../graphics/cities_CO_pdp.png)

## Neighbourhood Scale

Model fit:

![](../graphics/neighbourhoods_CO_model-fit.png)

Most important variables:

```{r}
#| echo: false
#| eval: true
#| label: nhood-co-metrics

last_rf_model <- final_models$neighbourhoods_CO
df_train <- dataset_split[[9]]$train
df_test <- dataset_split[[9]]$test

bind_rows(
  augment(last_rf_model, new_data = df_train) %>% 
    mutate(type = "train"),
  augment(last_rf_model, new_data = df_test) %>% 
    mutate(type = "test")) %>% 
  group_by(type) %>% 
  metrics(value, .pred)
```

![](../graphics/neighbourhoods_CO_vip.png)

Relationships with most important variables:

![](../graphics/neighbourhoods_CO_pdp.png)

# SO2

## City Scale

![](../graphics/cities_SO2_model-fit.png)

Most important variables:

```{r}
#| echo: false
#| eval: true
#| label: city-so2-metrics

last_rf_model <- final_models$cities_SO2
df_train <- dataset_split[[6]]$train
df_test <- dataset_split[[6]]$test

bind_rows(
  augment(last_rf_model, new_data = df_train) %>% 
    mutate(type = "train"),
  augment(last_rf_model, new_data = df_test) %>% 
    mutate(type = "test")) %>% 
  group_by(type) %>% 
  metrics(value, .pred)
```

![](../graphics/cities_SO2_vip.png)

Relationships with most important variables:

![](../graphics/cities_SO2_pdp.png)

## Neighbourhood Scale

Model fit:

![](../graphics/neighbourhoods_SO2_model-fit.png)

Most important variables:

```{r}
#| echo: false
#| eval: true
#| label: nhood-so2-metrics

last_rf_model <- final_models$neighbourhoods_SO2
df_train <- dataset_split[[12]]$train
df_test <- dataset_split[[12]]$test

bind_rows(
  augment(last_rf_model, new_data = df_train) %>% 
    mutate(type = "train"),
  augment(last_rf_model, new_data = df_test) %>% 
    mutate(type = "test")) %>% 
  group_by(type) %>% 
  metrics(value, .pred)
```

![](../graphics/neighbourhoods_SO2_vip.png)

Relationships with most important variables:

![](../graphics/neighbourhoods_SO2_pdp.png)

# NO2

## City Scale

![](../graphics/cities_NO2_model-fit.png)

Most important variables:

```{r}
#| echo: false
#| eval: true
#| label: city-no2-metrics

last_rf_model <- final_models$cities_NO2
df_train <- dataset_split[[4]]$train
df_test <- dataset_split[[4]]$test

bind_rows(
  augment(last_rf_model, new_data = df_train) %>% 
    mutate(type = "train"),
  augment(last_rf_model, new_data = df_test) %>% 
    mutate(type = "test")) %>% 
  group_by(type) %>% 
  metrics(value, .pred)
```

![](../graphics/cities_NO2_vip.png)

Relationships with most important variables:

![](../graphics/cities_NO2_pdp.png)

## Neighbourhood Scale

Model fit:

![](../graphics/neighbourhoods_NO2_model-fit.png)

Most important variables:

```{r}
#| echo: false
#| eval: true
#| label: nhood-no2-metrics

last_rf_model <- final_models$neighbourhoods_NO2
df_train <- dataset_split[[10]]$train
df_test <- dataset_split[[10]]$test

bind_rows(
  augment(last_rf_model, new_data = df_train) %>% 
    mutate(type = "train"),
  augment(last_rf_model, new_data = df_test) %>% 
    mutate(type = "test")) %>% 
  group_by(type) %>% 
  metrics(value, .pred)
```

![](../graphics/neighbourhoods_NO2_vip.png)

Relationships with most important variables:

![](../graphics/neighbourhoods_NO2_pdp.png)

# O3

## City Scale

![](../graphics/cities_O3_model-fit.png)

Most important variables:

```{r}
#| echo: false
#| eval: true
#| label: city-o3-metrics

last_rf_model <- final_models$cities_O3
df_train <- dataset_split[[5]]$train
df_test <- dataset_split[[5]]$test

bind_rows(
  augment(last_rf_model, new_data = df_train) %>% 
    mutate(type = "train"),
  augment(last_rf_model, new_data = df_test) %>% 
    mutate(type = "test")) %>% 
  group_by(type) %>% 
  metrics(value, .pred)
```

![](../graphics/cities_O3_vip.png)

Relationships with most important variables:

![](../graphics/cities_O3_pdp.png)

## Neighbourhood Scale

Model fit:

```{r}
#| echo: false
#| eval: true
#| label: nhood-o3-metrics

last_rf_model <- final_models$neighbourhoods_O3
df_train <- dataset_split[[11]]$train
df_test <- dataset_split[[11]]$test

bind_rows(
  augment(last_rf_model, new_data = df_train) %>% 
    mutate(type = "train"),
  augment(last_rf_model, new_data = df_test) %>% 
    mutate(type = "test")) %>% 
  group_by(type) %>% 
  metrics(value, .pred)
```

![](../graphics/neighbourhoods_O3_model-fit.png)

Most important variables:

![](../graphics/neighbourhoods_O3_vip.png)

Relationships with most important variables:

![](../graphics/neighbourhoods_O3_pdp.png)

# Notes

-   air pollution units don't match WHO guidelines, hard to assess if they are at relevant levels... need to figure this out

-   including street direction in models was a mistake, rerunning that and the UV partial dependency plot now

-   city-scale : doy, ndvi, ndbi best predictors in general. some socioeconomic vars.

-   neighbourhood-scale: tree vars best predictors.

-   mixed relationships: often peaks or valleys appear once a certain threshold is reached. cities that have high levels respond opposite to those w low levels.

-   models: often a lot of noise, not great at predicting extremes
