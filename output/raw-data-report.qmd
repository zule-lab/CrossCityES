---
title: "Raw Data Report"
execute:
  echo: false
  warning: false
  error: false
format: html
---

```{r}
#| label: setup
#| include: false


knitr::opts_chunk$set(echo = T)
options(tidyverse.quiet = T)

library(targets)
tar_source('R')
```


```{r}
#| echo: false
#| eval: true
#| label: data-prep

tar_load(cities_lst_full)
tar_load(cities_pollution_full) 
tar_load(neighbourhoods_lst_full)
tar_load(neighbourhoods_pollution_full)
tar_load(roads_lst_full)
tar_load(can_trees)

```

## (Not really all that) Quick & Dirty

-   These are the raw data results for *most* of the variables for chapter 1 data
-   NOTES: still missing tree functional diversity measures


## Workflow

```{r}
#| echo: false
#| warning: false
#| message: false
#| fig-width: 15
#| fig-height: 15
#| output: false
#| label: visnetwork

tar_visnetwork(targets_only = T, outdated = F)
```

## Tree Stuff

Number of trees per city:

```{r}
#| echo: false
#| warning: false
#| message: false
#| fig-width: 15
#| fig-height: 15
#| label: ntrees

can_trees %>% 
  st_drop_geometry() %>% 
  group_by(city) %>% 
  tally() %>% 
  arrange(n) %>%
  ggplot(., aes(x = city, y = n, fill = city)) + 
  geom_col() + 
  scale_fill_manual(values=met.brewer("Archambault", 7)) + 
  theme_classic()  + 
  ylab("Number of Trees")

```

Number of tree **species** per city:

```{r}
#| echo: false
#| warning: false
#| message: false
#| fig-width: 15
#| fig-height: 15
#| label: nspecies

can_trees %>% 
  st_drop_geometry() %>% 
  group_by(city, fullname) %>% 
  tally() %>% 
  group_by(city) %>% 
  tally() %>% 
  arrange(n) %>%
  ggplot(., aes(x = city, y = n, fill = city)) + 
  geom_col() + 
  scale_fill_manual(values=met.brewer("Archambault", 7)) + 
  theme_classic()  + 
  ylab("Number of Tree Species")
```

Tree size distribution per city:

```{r}
#| echo: false
#| warning: false
#| message: false
#| fig-width: 15
#| fig-height: 15
#| label: dbh

ggplot(can_trees, aes(x = dbh, group = city, col = city)) + 
  geom_density(alpha= 0.02, mapping = aes(y= ..count..)) +
  theme_classic() + 
  xlim(c(0,100)) + 
  xlab("DBH (cm)")+ 
  ylab("Density")+ 
  
  scale_colour_manual(values=met.brewer("Archambault", 7)) +
  theme(legend.position = "top", axis.title = element_text(face= "bold", size= 18), axis.text.x = element_text(size= 18), axis.text.y = element_text(size= 18))

```

## City Scale

### Response Variables

-   Response variables are proxies for ES
    -   Land Surface Temperature
    -   Air Pollution measures for 6 pollutants

```{r}
#| echo: false
#| warning: false
#| message: false
#| fig-width: 15
#| fig-height: 15
#| label: city-response

city_response_vars <- rbind(
  cities_lst_full %>% select(c(city, mean_temp, stdDev_temp)) %>% pivot_longer(-city, names_to = 'variable'),
  cities_pollution_full %>% select(c(city, variable, value)) 
)

city_response_vars %>%
    mutate(value = as.numeric(value)) %>%
    arrange(value) %>%   # First sort by val. 
    # this sort the dataframe but NOT the factor levels
    ggplot(., aes(x = city, y = value, fill = city)) + 
    geom_boxplot() + 
    geom_point(size = 0.25) +  
    scale_fill_manual(values=met.brewer("Archambault", 7)) + 
    facet_wrap(vars(variable), scales = "free_y") + 
    theme_classic() + 
    theme(axis.text.x = element_blank(),
          axis.ticks.x = element_blank()) + 
    ylab("") + 
    xlab("")

```

### Independent Variables - Trees


```{r}
#| echo: false
#| warning: false
#| message: false
#| fig-width: 15
#| fig-height: 15
#| label: city-tree

city_tree_vars <- cities_lst_full %>% 
  select(c(city, nTrees, ba_per_m2, stemdens, SpeciesRichness, Shannon, nFG, mean_dbh, sd_dbh)) %>% 
  mutate(ba_per_m2 = drop_units(ba_per_m2), 
         stemdens = drop_units(stemdens),
         mean_dbh = drop_units(mean_dbh),
         sd_dbh = drop_units(sd_dbh)) %>%
  pivot_longer(-city, names_to = 'variable') %>%
  distinct()

city_plot(city_tree_vars)
```

### Independent Variables - Built Infrastructure

-   includes building density, building height, road density, proportion of road types, NDVI, and NDBI

```{r}
#| echo: false
#| warning: false
#| message: false
#| fig-width: 15
#| fig-height: 15
#| label: city-building


city_building_vars <- cities_lst_full %>% 
  select(c(city, centroid_den, area_den, prop_highway, prop_strts, road_dens, mean_bldhgt, NDBI_mean_, NDBI_stdDev_, NDVI_mean_, NDVI_stdDev_)) %>% 
  pivot_longer(-city, names_to = 'variable') %>% 
  distinct()

city_plot(city_building_vars)

```

### Independent Variables - Census

-   includes data from 2021 census on:
    -   totpop = Population 2021

    -   popdens = Pop density per sq km

    -   area = Land area sq km

    -   sidho = Single-detached house

    -   semho = Semi-detached house

    -   rowhou = Row house

    -   aptdup = Apartment or flat in a duplex

    -   aptbui = Apartment in a building that has fewer than five storeys

    -   aptfiv = Apartment in a building that has five or more storeys otsiho = Other single-attached house

    -   mvdwel = Movable dwelling (9)

    -   medinc = Median after-tax income in 2015 among recipients

    -   lowinc = Prevalence of low income based on the Low-income measure, after tax (LIM-AT) (%)

    -   recimm = Total - Immigrant status and period of immigration for the population in private households - 25% sample data (63) -\> Immigrants -\> 2011-2016 (recent immigrants)

    -   aborig = Total - Aboriginal identity for the population in private households - 25% sample data (104) -\> Aboriginal identity (105)

    -   vismin = Total - Visible minority for the population in private households - 25% sample data (121) -\> Total visible minority population (122)

```{r}
#| echo: false
#| warning: false
#| message: false
#| fig-width: 15
#| fig-height: 15
#| label: city-census


city_census_vars <- cities_lst_full %>% 
  select(c(city, popdens, sidehop, aptfivp, semhoup, rowhoup, aptdupp, aptbuip, mvdwelp, medinc, lowincp, recimmp, indigp, visminp, edubacp)) %>% 
  pivot_longer(-city, names_to = 'variable') %>% 
  distinct()

city_plot(city_census_vars)
```


## Neighbourhood Scale

### Response Variables

```{r}
#| echo: false
#| warning: false
#| message: false
#| fig-width: 15
#| fig-height: 15
#| label: neighbourhood-response

neighbourhood_response_vars <- rbind(
  neighbourhoods_lst_full %>% select(c(city, hood, date, time, mean_temp, stdDev_temp)) %>% pivot_longer(-c(city, hood, date, time), names_to = 'variable'),
  neighbourhoods_pollution_full %>% select(c(city, hood, date, time, variable, value)) 
)

neighbourhood_plot(neighbourhood_response_vars)


```

```{r}
#| echo: false
#| warning: false
#| message: false
#| fig-width: 15
#| fig-height: 15
#| label: neighbourhood-pollution-pca

neighbourhood_pollution_pca <- neighbourhoods_pollution_full %>% select(c(city, hood, date, time, variable, value)) %>% pivot_wider(names_from = variable, values_from = value, values_fn = first) %>% select(-c(date, time))

neighbourhood_pca(neighbourhood_pollution_pca, city, hood)
```


### Independent Variables - Trees

```{r}
#| echo: false
#| warning: false
#| message: false
#| fig-width: 15
#| fig-height: 15
#| label: neighbourhood-tree

neighbourhood_tree_vars <- neighbourhoods_lst_full %>% select(c(city, hood, nTrees, ba_per_m2, stemdens, SpeciesRichness, Shannon, nFG, mean_dbh, sd_dbh)) %>% 
mutate(ba_per_m2 = drop_units(ba_per_m2),
stemdens = drop_units(stemdens),
mean_dbh = drop_units(mean_dbh),
sd_dbh = drop_units(sd_dbh)) %>%
pivot_longer(-c(city, hood), names_to = 'variable') 

neighbourhood_plot(neighbourhood_tree_vars)
```

```{r}
#| echo: false
#| warning: false
#| message: false
#| fig-width: 15
#| fig-height: 15
#| label: neighbourhood-tree-pca

neighbourhood_tree_vars_pca <- neighbourhoods_lst_full %>% select(c(city, hood, nTrees, ba_per_m2, stemdens, SpeciesRichness, Shannon, nFG, mean_dbh, sd_dbh)) %>% 
mutate(ba_per_m2 = drop_units(ba_per_m2),
stemdens = drop_units(stemdens),
mean_dbh = drop_units(mean_dbh),
sd_dbh = drop_units(sd_dbh))  %>%
drop_na()

neighbourhood_pca(neighbourhood_tree_vars_pca, city, hood)
```

### Independent Variables - Built Infrastructure

```{r}
#| echo: false
#| warning: false
#| message: false
#| fig-width: 15
#| fig-height: 15
#| label: neighbourhood-building


neighbourhood_building_vars <- neighbourhoods_lst_full %>% 
  select(c(city, hood, centroid_den, area_den, prop_highway, prop_strts, road_dens, mean_bldhgt, NDBI_mean_, NDBI_stdDev_, NDVI_mean_, NDVI_stdDev_)) %>% 
  pivot_longer(-c(city, hood), names_to = 'variable')

neighbourhood_plot(neighbourhood_building_vars)
```

```{r}
#| echo: false
#| warning: false
#| message: false
#| fig-width: 15
#| fig-height: 15
#| label: neighbourhood-built-pca

neighbourhood_built_vars_pca <- neighbourhoods_lst_full %>% 
  select(c(city, hood, centroid_den, area_den, prop_highway, prop_strts, road_dens, mean_bldhgt, NDBI_mean_, NDBI_stdDev_, NDVI_mean_, NDVI_stdDev_)) 

neighbourhood_pca(neighbourhood_built_vars_pca, city, hood)
```

### Independent Variables - Census

```{r}
#| echo: false
#| warning: false
#| message: false
#| fig-width: 15
#| fig-height: 15
#| label: neighbourhood-census


neighbourhood_census_vars <- neighbourhoods_lst_full %>% 
  select(c(city, hood, popdens, sidehop, aptfivp, semhoup, rowhoup, aptdupp, aptbuip, mvdwelp, medinc, lowincp, recimmp, indigp, visminp, edubacp)) %>% 
  pivot_longer(-c(city, hood), names_to = 'variable')

neighbourhood_plot(neighbourhood_census_vars)
```

```{r}
#| echo: false
#| warning: false
#| message: false
#| fig-width: 15
#| fig-height: 15
#| label: census-built-pca

neighbourhood_census_vars_pca <- neighbourhoods_lst_full %>% 
  select(c(city, hood, popdens, sidehop, aptfivp, semhoup, rowhoup, aptdupp, aptbuip, mvdwelp, medinc, lowincp, recimmp, indigp, visminp, edubacp)) 

neighbourhood_pca(neighbourhood_census_vars_pca, city, hood)
```

## Street Scale

### Response Variables

```{r}
#| echo: false
#| warning: false
#| message: false
#| fig-width: 15
#| fig-height: 15
#| label: street-response

street_response_vars <- roads_lst_full %>% select(c(city, streetid, date, time, mean_temp, stdDev_temp)) %>%
drop_na(city) %>% pivot_longer(-c(city, streetid, date, time), names_to = 'variable') %>%
  drop_na(city)

neighbourhood_plot(street_response_vars)


```




### Independent Variables - Trees

```{r}
#| echo: false
#| warning: false
#| message: false
#| fig-width: 15
#| fig-height: 15
#| label: street-tree

street_tree_vars <- roads_lst_full %>% select(c(city, streetid, nTrees, ba_per_m2, stemdens, SpeciesRichness, Shannon, nFG, mean_dbh, sd_dbh)) %>% 
mutate(ba_per_m2 = drop_units(ba_per_m2),
stemdens = drop_units(stemdens),
mean_dbh = drop_units(mean_dbh),
sd_dbh = drop_units(sd_dbh)) %>%
pivot_longer(-c(city, streetid), names_to = 'variable') %>% drop_na(city)

neighbourhood_plot(street_tree_vars)
```

```{r}
#| echo: false
#| warning: false
#| message: false
#| fig-width: 15
#| fig-height: 15
#| label: street-tree-pca

street_tree_vars_pca <- roads_lst_full %>% select(c(city, streetid, nTrees, ba_per_m2, stemdens, SpeciesRichness, Shannon, nFG, mean_dbh, sd_dbh)) %>% 
mutate(ba_per_m2 = drop_units(ba_per_m2),
stemdens = drop_units(stemdens),
mean_dbh = drop_units(mean_dbh),
sd_dbh = drop_units(sd_dbh)) %>%
  drop_na(city)

neighbourhood_pca(street_tree_vars_pca, city, streetid)
```

### Independent Variables - Built Infrastructure

```{r}
#| echo: false
#| warning: false
#| message: false
#| fig-width: 15
#| fig-height: 15
#| label: street-building


street_building_vars <- roads_lst_full %>% 
  select(c(city, streetid, centroid_den, area_den, mean_bldhgt, NDBI_mean_, NDBI_stdDev_, NDVI_mean_, NDVI_stdDev_)) %>% 
  pivot_longer(-c(city, streetid), names_to = 'variable') %>% drop_na(city)

neighbourhood_plot(street_building_vars)
```

```{r}
#| echo: false
#| warning: false
#| message: false
#| fig-width: 15
#| fig-height: 15
#| label: street-built-pca

street_built_vars_pca <- roads_lst_full %>% 
  select(c(city, streetid, centroid_den, area_den, mean_bldhgt, NDBI_mean_, NDBI_stdDev_, NDVI_mean_, NDVI_stdDev_)) %>% drop_na(city)

neighbourhood_pca(street_built_vars_pca, city, streetid)
```

### Independent Variables - Census

```{r}
#| echo: false
#| warning: false
#| message: false
#| fig-width: 15
#| fig-height: 15
#| label: street-census


street_census_vars <- roads_lst_full %>% 
  select(c(city, streetid, popdens, sidehop, aptfivp, semhoup, rowhoup, aptdupp, aptbuip, mvdwelp, medinc, lowincp, recimmp, indigp, visminp, edubacp)) %>% 
  pivot_longer(-c(city, streetid), names_to = 'variable') %>% drop_na(city)

neighbourhood_plot(street_census_vars)
```

```{r}
#| echo: false
#| warning: false
#| message: false
#| fig-width: 15
#| fig-height: 15
#| label: street-census-pca

street_census_vars_pca <-roads_lst_full %>% 
  select(c(city, streetid, popdens, sidehop, aptfivp, semhoup, rowhoup, aptdupp, aptbuip, mvdwelp, medinc, lowincp, recimmp, indigp, visminp, edubacp)) %>% drop_na(city)

neighbourhood_pca(street_census_vars_pca, city, streetid)
```